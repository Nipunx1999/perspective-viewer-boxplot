<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Perspective BoxPlot Plugin Example</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/css/themes.css">

    <!-- Choose a theme: material / pro -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/css/material.css">
</head>
<body>
<div style="margin: 20px;">
    <h1>BoxPlot Plugin Demo</h1>

    <perspective-viewer
            id="viewer"
            style="width: 100%; height: 500px; border: 1px solid #ccc;">
    </perspective-viewer>
</div>

<!-- Load dependencies -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@finos/perspective/dist/umd/perspective.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/umd/perspective-viewer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-datagrid/dist/umd/perspective-viewer-datagrid.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-d3fc/dist/umd/perspective-viewer-d3fc.js"></script>

<!-- Custom BoxPlot plugin -->
<script src="/dist/perspective-viewer-boxplot.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', async function () {
        console.log("DOM ready, creating dataset...");

        // Generic boxplot data: test with different categorical column names
        const regions = ["North", "South", "East", "West", "Central"]; // Test generic categorical column
        const departments = ["Sales", "Marketing", "Engineering"]; // Additional categorical column 
        const accounts = ["AccountA", "AccountB", "AccountC", "AccountD"]; // Column to ignore

        const data = [];
        let idCounter = 0;

        regions.forEach(region => {
            departments.forEach(department => {
                for (let i = 0; i < 100; i++) { // More data points per region/dept for better boxplots
                    // Base values that vary by region
                    let baseSales, baseProfit;
                    switch(region) {
                        case "North": 
                            baseSales = 20;
                            baseProfit = 15;
                            break;
                        case "South": 
                            baseSales = 35;
                            baseProfit = 28;
                            break;
                        case "East": 
                            baseSales = 25;
                            baseProfit = 18;
                            break;
                        case "West": 
                            baseSales = 40;
                            baseProfit = 32;
                            break;
                        case "Central": 
                            baseSales = 30;
                            baseProfit = 22;
                            break;
                        default: 
                            baseSales = 25;
                            baseProfit = 18;
                    }
                    
                    // Department modifier
                    if (department === "Sales") {
                        baseSales += 5;
                        baseProfit += 3;
                    } else if (department === "Engineering") {
                        baseSales -= 3;
                        baseProfit -= 2;
                    }
                    
                    // Add realistic noise/variation
                    const salesNoise = (Math.random() - 0.5) * 15; // ±7.5 variation
                    const profitNoise = (Math.random() - 0.5) * 12; // ±6 variation
                    
                    const sales = Math.max(1, baseSales + salesNoise);
                    const profit = Math.max(1, baseProfit + profitNoise);

                    data.push({
                        id: idCounter++,
                        region,
                        department,
                        account: accounts[Math.floor(Math.random() * accounts.length)], // Ignore this
                        sales: Number(sales.toFixed(2)),
                        profit: Number(profit.toFixed(2))
                    });
                }
            });
        });

        console.log("Dataset rows:", data.length);

        try {
            // Schema with generic column names
            const schema = {
                id: "integer",
                region: "string",      // Test generic categorical column
                department: "string",  // Second categorical column  
                account: "string",     // Another categorical (should be ignored)
                sales: "float",
                profit: "float"
            };

            const worker = window.perspective.worker();
            const table = await worker.table(data, { schema });

            const viewer = document.getElementById("viewer");
            await viewer.load(table);

            // Apply boxplot config after plugin registers
            setTimeout(async () => {
                try {
                    await viewer.restore({
                        plugin: "boxplot",
                        // Test with multiple categorical columns - should show warning and default to first
                        columns: ["region", "department", "sales", "profit"] // Multiple categorical + metrics
                    });
                    console.log("Boxplot configured ✅");
                } catch (err) {
                    console.error("Error configuring boxplot:", err);
                    console.log("Available plugins:",
                        viewer.getAvailablePlugins ? await viewer.getAvailablePlugins() : "N/A");
                }
            }, 1000);

        } catch (error) {
            console.error("Error loading perspective:", error);
        }
    });
</script>
</body>
</html>